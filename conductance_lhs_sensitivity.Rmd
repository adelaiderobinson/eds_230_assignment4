---
title: 'Assignment 4: Sensitivity with LHS'
author: "Jessica French, Michelle Lam, Adelaide Robinson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(lhs)
library(purrr)
```

# Generate samples of parameter values to test sensitivity using LHS
```{r}
# read in Catm.R function
source("Catm.R")

# set seed
set.seed(2383)

# define parameters that we will vary to perform sensitivity analysis
pnames <- c("height", "k_d", "k_o", "v")

# define how many parameters
npar =  length(pnames)

# define how many samples
nsample = 100

# create matrix with 100 random samples for the 4 parameters
parm_quant = randomLHS(nsample, npar)
colnames(parm_quant)=pnames

# create an empty dataframe with each column representing a parameter and 100 rows for 100 samples
parm = as.data.frame(matrix(nrow=nrow(parm_quant), ncol=ncol(parm_quant)))
colnames(parm) = pnames

# Windspeeds v are normally distributed with a mean of 250 cm/s with a standard deviation of 30 cm/s
# convert to m/s by dividing by 100
parm[,"v"] = qnorm(parm_quant[,"v"], mean=250/100, sd=30/100)

# For vegetation height assume that height is somewhere between 9.5 and 10.5 m (but any value in that range is equally likely)
parm[,"height"] = qunif(parm_quant[,"height"], min=9.5, max=10.5)

# For the kd and k0 parameters you can assume that they are normally distributed with standard deviation of 1% of their default values 
parm[,"k_d"] = qnorm(parm_quant[,"k_d"], mean=0.7, sd=0.7*0.01)
parm[,"k_o"] = qnorm(parm_quant[,"k_o"], mean=0.1, sd=0.1*0.01)
```


# Run the samples through the conductance model/function
```{r}
# run model for all parameter values generated by LHS
conductance = parm |> pmap(Catm)

# take a look at conductance
head(conductance)

# turn results into a dataframe
conductance_df = conductance |> 
  map_dfr(~data.frame(Ca = .))
```

# Plotting
## Plot conductance estimates in a way that accounts for parameter uncertainty
```{r}
ggplot(data = conductance_df, aes(y = Ca, x = "")) +
  geom_boxplot(col = "darkorchid") +
  labs(y = "Conductance (mm/s)") +
  theme_minimal() +
  labs(x = "")

# cumulative distribution
ggplot(conductance_df, aes(Ca))+stat_ecdf()+
  theme_minimal()
```

## Plot conductance estimates against each of the parameters
```{r}
# combine Ca values to parms into a dataframe
results <- cbind.data.frame(conductance_df, parm)

# reshape data so that you have one column for Ca value, one column for parameter type, and one column for parameter value
results2 <- results |> 
  gather(height, k_d, k_o, v, value="parmvalue",key="parm")

ggplot(results2, aes(x = parmvalue, y = Ca, col = parm)) +
  geom_point() +
  facet_wrap(~parm,scales = "free", ncol = 4) +
  labs(x = "Parameter Values", y = "Conductance (mm/s)") +
  theme_minimal()
```


# Estimate Partial Rank Correlation Coefficients
```{r}
senresult <- pcc(parm, conductance_df$Ca, rank = T)

plot(senresult)

print(senresult$PRCC)
```

# Results Discussion

From the scatter plot of conductance and parameter values it appears that conductance is most sensitive to variation in velocity. The partial rank coefficient is highest for velocity which is consistent with the our interpretation of the scatter plot. This suggests that to reduce the uncertainty in aerodynamic conductance estimates we would want to focus on reducing the uncertainty in the velocity measurement. 

This would suggest that in a changing climate with more unpredictable and severe weather plant water user will be affected by changing wind speed and direction. It could also affect our ability to accurately estimate plant water use as variability in wind velocity becomes more uncertain. 